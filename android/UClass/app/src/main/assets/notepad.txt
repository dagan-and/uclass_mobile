// 사유 선택 시
$(document).on('click', '.reason-item', function (e) {
  const reasonId = this.getAttribute('data-reason-id');
  loadReasonDetail(reasonId);
});

// 사유 등록 버튼 클릭 이벤트
$('#joinForm #btnSubmitReason').on('click', function (e) {
  e.preventDefault();
  submitReason();
});

// 사유 삭제 모달 확인 버튼 클릭 이벤트
$('#modal-delete #btnDeleteReason').on('click', function (e) {
  e.preventDefault();
  deleteReason(currentId);
});

// 출결종류 선택 시 해당 시간 필드만 표시
$('#modal-attendance .select-list li').on('click', function () {
  const type = $(this).data('att'); // data-att 값 가져오기

  // 모든 출결종류 필드 숨김
  document.querySelectorAll('[data-att-fields]').forEach(f => {
    f.hidden = true;
  });

  // 선택한 출결종류 필드만 표시
  if (type) {
    const targetField = document.querySelector(`[data-att-fields="${type}"]`);
    if (targetField) {
      targetField.hidden = false;
    }
  }
});

/**
 * 시간 필드 초기화 함수
 * - 페이지 로드 시 기존에 있는 모든 .form-time 필드에 이벤트 바인딩
 * - HTML 동적 생성 없이 hidden 속성으로만 제어
 */
function initTimeFields() {
  document.querySelectorAll(".form-time").forEach(box => {
    const label = box.querySelector("label.lbl");
    const input = box.querySelector('input[type="time"]');
    const btn = box.querySelector(".btn-time");
    if (!input || !btn || !label) {
      return;
    }

    // 이미 초기화된 필드는 건너뛰기
    if (box.dataset.initialized === 'true') {
      return;
    }
    box.dataset.initialized = 'true';

    // id/for 매칭 (기존 ID가 없을 때만 자동 생성)
    if (!input.id || input.id === '') {
      const newId = `time-${autoIdSeq++}`;
      input.id = newId;
      label.setAttribute("for", newId);
    } else {
      // 기존 ID가 있으면 label의 for만 맞춰줌
      label.setAttribute("for", input.id);
    }

    // 기본 텍스트 저장
    if (!btn.dataset.default) {
      btn.dataset.default = btn.textContent.trim();
    }

    const applySelected = () => {
      if (input.value) {
        btn.textContent = input.value;
        box.classList.remove("is-focus");
        box.classList.add("has-value");
      } else {
        btn.textContent = btn.dataset.default;
        box.classList.remove("has-value");
      }
    };

    // 버튼 클릭 → 포커스 상태
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      box.classList.add("is-focus");
      if (typeof input.showPicker === "function") {
        input.showPicker();
      } else {
        input.focus();
      }
    });

    // 값 선택(변경) → 포커스 해제 + has-value
    input.addEventListener("input", applySelected);
    input.addEventListener("change", applySelected);

    // 바깥 클릭 → 값 없으면 포커스 해제
    document.addEventListener("click", (e) => {
      if (!box.contains(e.target) && !input.value) {
        box.classList.remove("is-focus");
        btn.textContent = btn.dataset.default;
      }
    });

    // 초기 반영
    applySelected();
  });
}

function setCurrentId(reasonId) {
  currentId = reasonId;
}

/**
 * 사유 목록 조회 및 렌더링
 */
async function loadReasonList() {
  try {
    // 로딩 표시
    if (window.showLoading) {
      window.showLoading();
    }

    // API 호출
    const response = await apiService.reason.selectReasonList(0, 1000);

    if (response.success && response.data) {
      // response 구조: { content, pageNumber, pageSize, totalElements, ... }
      const reasonList = response.data.content || [];

      // 데이터 렌더링
      renderReasonList(reasonList);

      console.log('✅ 사유 목록 조회 성공:', reasonList.length, '건');
    } else {
      console.error('❌ 사유 목록 조회 실패:', response.message);
      renderEmptyReason('사유 목록 조회를 실패했습니다.');
    }

  } catch (error) {
    console.error('❌ 사유 목록 조회 중 오류:', error);
    renderEmptyReason('사유 목록 조회를 실패했습니다.');
  } finally {
    // 로딩 숨김
    if (window.hideLoading) {
      window.hideLoading();
    }
  }
}

/**
 * 사유 목록 화면에 표시
 * @param {Array} reasonList - 사유 배열
 */
function renderReasonList(reasonList) {

  // 사유 목록이 들어갈 컨테이너 선택
  const $bindingList = $('#bindingList');
  if (!$bindingList.length) {
    console.warn('⚠️ #bindingList 요소를 찾을 수 없습니다.');
    return;
  }

  if (!reasonList || reasonList.length === 0) {
    renderEmptyReason('등록된 정보가 없습니다.');
    return;
  }

  // HTML 생성 - 각 사유을 <a> 태그로 생성
  const html = reasonList.map(reason => createReasonItemHtml(reason)).join('');

  // 컨테이너에 직접 바인딩
  $bindingList.html(html);

  console.log(`✅ 사유 ${reasonList.length} 건이 렌더링되었습니다.`);
}

/**
 * 사유 목록 아이템 HTML 생성
 * - 퍼블리싱 HTML 구조 적용
 * @param {Object} reason - 사유 객체
 * @returns {string} HTML 문자열
 */
function createReasonItemHtml(reason) {

  // 날짜 포맷팅
  const dateObj = new Date(reason.createdAt);
  const formattedDate = commonUtils.formatDate(dateObj, 'MM-DD');
  const formattedTime = commonUtils.formatDate(dateObj, 'HH:mm');

  // 사유 유형
  const requestType = reason.requestType;
  let requestTypeText;
  if (requestType === 'LATE') {
    requestTypeText = '지각';
  } else if (requestType === 'ABSENT') {
    requestTypeText = '결석';
  } else if (requestType === 'EARLY_LEAVE') {
    requestTypeText = '조퇴';
  } else {
    requestTypeText = '외출';
  }

  // 사유
  const reasonText = requestTypeText + ", " + reason.reason;

  // 학부모 승인 상태
  const parentApprovalStatus = reason.parentApprovalStatus;
  let modalHtml, tagHtml;
  if (parentApprovalStatus === 'PENDING') {
    modalHtml = `<a href="javascript:;" class="reason-item item" data-modal-open="modal-detail-uncon" data-reason-id="${reason.id}">`;
    tagHtml = `<span class="answer-item answer--uncon">미승인</span>`;
  } else {
    modalHtml = `<a href="javascript:;" class="reason-item item" data-modal-open="modal-detail-parents" data-reason-id="${reason.id}">`;
    tagHtml = `<span class="answer-item answer--parents">학부모 승인</span>`;
  }

  let html = `
    <div class="card">
  `;
  html += modalHtml;
  html += `
        <div class="item__inner">
          <div class="item__answer">
  `;
  html += tagHtml;
  html += `
          </div>
          <div class="item__body">
            <p class="item__meta">
              <span class="item__date">${formattedDate}</span>
              <span class="item__time">${formattedTime}</span>
            </p>
            <h2 class="item__title">${reasonText}</h2>
          </div>
        </div>
      </a>
      <button onclick="setCurrentId(${reason.id})" type="button" class="item__close" aria-label="삭제" data-modal-open="modal-delete"></button>
    </div>
  `;

  return html;
}

/**
 * 사유 상세 조회 및 표시
 * @param {number} reasonId - 사유 ID
 */
async function loadReasonDetail(reasonId) {
  try {
    // 로딩 표시
    if (window.showLoading) {
      window.showLoading();
    }

    // API 호출
    const response = await apiService.reason.selectReasonInfo(reasonId);

    if (response.success && response.data) {
      const reason = response.data;

      // 상세 내용 표시
      renderReasonDetail(reason);

      console.log('✅ 사유 상세 조회 성공:', reason.title);
    } else {
      console.error('❌ 사유 상세 조회 실패:', response.message);
      alert('사유 상세 조회를 실패했습니다.');
    }

  } catch (error) {
    console.error('❌ 사유 상세 조회 중 오류:', error);
    alert('사유 상세 조회를 실패했습니다.');
  } finally {
    // 로딩 숨김
    if (window.hideLoading) {
      window.hideLoading();
    }
  }
}

/**
 * 사유 상세 내용 표시
 * @param {Object} reason - 사유 객체
 */
function renderReasonDetail(reason) {

  // 날짜 포맷팅
  const requestDate = commonUtils.formatDate(reason.requestDate, 'YYYY-MM-DD');
  const availableEntryTime = (reason.availableEntryTime || '').slice(0, 5);
  const earlyLeaveTime = (reason.earlyLeaveTime || '').slice(0, 5);
  const outingStartTime = (reason.outingStartTime || '').slice(0, 5);
  const outingEndTime = (reason.outingEndTime || '').slice(0, 5);

  // 사유
  const requestType = reason.requestType;
  let requestTypeText, requestDetailHtml;
  if (requestType === 'LATE') {
    requestTypeText = '지각';
    requestDetailHtml = `<div class="record">
        <span class="record__label">입실 가능 시간</span>
        <span class="record__label"><strong>${availableEntryTime}</strong></span>
      </div>
    `;
  } else if (requestType === 'ABSENT') {
    requestTypeText = '결석';
    requestDetailHtml = ``;
  } else if (requestType === 'EARLY_LEAVE') {
    requestTypeText = '조퇴';
    requestDetailHtml = `<div class="record">
        <span class="record__label">조퇴시간</span>
        <span class="record__label"><strong>${earlyLeaveTime}</strong></span>
      </div>
    `;
  } else {
    requestTypeText = '외출';
    requestDetailHtml = `<div class="record">
        <span class="record__label">조퇴시간</span>
        <span class="record__label"><strong>${outingStartTime}</strong></span>
      </div>
      <div class="record">
        <span class="record__label">복귀시간</span>
        <span class="record__label"><strong>${outingEndTime}</strong></span>
      </div>
    `;
  }

  $('.requestDate').text(requestDate);
  $('.requestType').text(requestTypeText);
  $('.reason').text(reason.reason);
  $('.requestDetail').html(requestDetailHtml);
}

// 사유 등록
async function submitReason() {

  const attendanceText = $('input#attendance').val();

  let attendance;
  if (attendanceText === '지각') {
    attendance = 'LATE';
  } else if (attendanceText === '결석') {
    attendance = 'ABSENT';
  } else if (attendanceText === '조퇴') {
    attendance = 'EARLY_LEAVE';
  } else {
    attendance = 'OUTING';
  }

  const schedule = $('#schedule').val();

  // 일정에 따라 날짜 계산
  let requestDate;
  if (schedule === '내일') {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    requestDate = commonUtils.formatDate(tomorrow, 'YYYY-MM-DD');
  } else {
    // "오늘" 또는 기본값
    requestDate = commonUtils.formatDate(new Date(), 'YYYY-MM-DD');
  }

  const timeCkin = formatTimeWithSeconds($('input#time_ckin').val());
  const timeLeave = formatTimeWithSeconds($('input#time_leave').val());
  const timeOut = formatTimeWithSeconds($('input#time_out').val());
  const timeReturn = formatTimeWithSeconds($('input#time_return').val());
  const reason = $('input#reason').val();

  // if (!attendanceText || !timeCkin || !timeLeave || !timeOut || !timeReturn || !reason) {
  //   alert("입력값을 확인해주세요.");
  //   return;
  // }

  try {
    // 사유 데이터
    const reasonData = {
      requestType: attendance,
      requestDate: requestDate,
      availableEntryTime: timeCkin,
      earlyLeaveTime: timeLeave,
      outingStartTime: timeOut,
      outingEndTime: timeReturn,
      reason: reason,
    };

    // 신규 등록
    const response = await apiService.reason.insertReasonInfo(reasonData);

    if (response.success) {
      alert('사유가 등록되었습니다.');

      window.location.href = '/uclass/reason';
    }
  } catch (error) {
    console.error('사유 등록 실패:', error);
    alert('사유 등록에 실패했습니다.');
  }
}

// 사유 삭제
async function deleteReason(reasonId) {
  try {
    // 사유 삭제
    const response = await apiService.reason.deleteReasonInfo(reasonId);

    if (response.success) {
      alert('사유가 삭제되었습니다.');

      window.location.href = '/uclass/reason';
    }
  } catch (error) {
    console.error('사유 삭제 실패:', error);
    alert('사유 삭제에 실패했습니다.');
  }
}

/**
 * 빈 사유 메시지 표시
 * @param {string} message - 표시할 메시지
 */
function renderEmptyReason(message) {
  const $bindingList = $('#bindingList');

  if (!$bindingList.length) {
    return;
  }

  const html = `
    <div class="empty-notice">
      <p class="empty-notice__message">${escapeHtml(message)}</p>
    </div>
  `;

  $bindingList.html(html);
}

/**
 * HTML 태그 제거
 * @param {string} html - HTML 문자열
 * @returns {string} 태그가 제거된 텍스트
 */
function stripHtmlTags(html) {
  if (!html) {
    return '';
  }

  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || '';
}

/**
 * HTML 이스케이프 처리
 * @param {string} text - 이스케이프할 텍스트
 * @returns {string} 이스케이프된 텍스트
 */
function escapeHtml(text) {
  if (!text) {
    return '';
  }

  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };

  return text.replace(/[&<>"']/g, m => map[m]);
}

/**
 * 시간 형식 변환 함수 (HH:mm → HH:mm:ss)
 * @param {string} time - HH:mm 형식의 시간 문자열
 * @returns {string|null} - HH:mm:ss 형식의 시간 문자열 또는 null
 */
function formatTimeWithSeconds(time) {
  if (!time || time.trim() === '') {
    return null;
  }
  // "22:32" → "22:32:00"
  return time + ':00';
}